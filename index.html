<!DOCTYPE html>
<html>
<head>
  <title>주파수 맞추기</title>
  <style>
    body { font-family: sans-serif; background-color: #f2f2f2; }
    .container { width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
    h1 { text-align: center; margin-bottom: 20px; color: #333; }
    .control-group { margin-bottom: 15px; display: flex; align-items: center; }
    .control-group label { width: 100px; font-weight: bold; }
    .button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; margin-right: 10px; font-size: 16px; border-radius: 4px; }
    .button:hover { background-color: #45a049; }
    .toggle-button { width: 60px; }
    .slider-container { flex-grow: 1; margin-right: 10px; }
    .slider { width: 100%; }
    .frequency-input { width: 80px; }
    #result-table { margin-top: 20px; border-collapse: collapse; width: 100%; }
    #result-table th, #result-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    #result-table th { background-color: #f0f0f0; }
    #attempt-count { margin-top: 10px; margin-bottom: 10px; font-size: 18px; }
    #show-table-button { margin-top: 10px; }
    #best-score { margin-top: 10px; font-size: 18px; color: #d50000; }
  </style>
</head>
<body>
  <div class="container">
    <h1>주파수 맞추기</h1>

    <div class="control-group">
      <button id="new-reference" class="button">새 기준음</button>
      <button id="reference-toggle" class="button toggle-button">▶</button>
      <label for="reference-toggle">기준음</label>
    </div>

    <div class="control-group">
      <button id="adjustable-toggle" class="button toggle-button">▶</button>
      <label for="adjustable-toggle">조정음</label>
    </div>

    <div class="control-group">
        <label for="frequency-slider">조정음 주파수:</label>
        <div class="slider-container">
            <input type="range" id="frequency-slider" class="slider" min="50" max="4500" value="440">
        </div>
        <input type="number" id="frequency-input" value="440">
        <button id="check-match" class="button">일치 확인</button>
    </div>

    <div class="control-group">
      <label for="volume-slider">볼륨:</label>
      <input type="range" id="volume-slider" class="slider" min="0" max="1" step="0.01" value="0.3">
    </div>

    <div id="attempt-count">시도 횟수: 0</div>
    <div id="best-score">최고 점수: -</div>

    <button id="show-table-button" class="button">결과 표 보기</button>
    <table id="result-table" hidden>
      <thead>
        <tr>
          <th>시도 횟수</th>
          <th>기준음 파형</th>
          <th>기준음 주파수 (Hz)</th>
          <th>조정음 파형</th>
          <th>조정음 주파수 (Hz)</th>
          <th>오차 범위 (Hz)</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <script>
  // AudioContext 생성
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  // 기준음 및 조정음 관련 변수
  let referenceOscillator;
  let adjustableOscillator;
  let referenceWaveform = 'sine'; // 기본값
  let referenceFrequency = 440; //기준 주파수
  let adjustableWaveform = 'sine'; //조정음 파형 기본값
  let adjustableFrequency = 440; //조정음 주파수
  let isReferencePlaying = false; // 기준음 재생 상태
  let isAdjustablePlaying = false; // 조정음 재생 상태

  // 볼륨 조절을 위한 GainNode 생성
  const gainNode = audioCtx.createGain();
  gainNode.connect(audioCtx.destination);
  gainNode.gain.value = 0.3; // 초기 볼륨 설정 (20% 감소)

  // UI 요소
  const newReferenceButton = document.getElementById('new-reference');
  const referenceToggleButton = document.getElementById('reference-toggle');
  const adjustableToggleButton = document.getElementById('adjustable-toggle');
  const frequencySlider = document.getElementById('frequency-slider');
  const frequencyInput = document.getElementById('frequency-input');
  const checkMatchButton = document.getElementById('check-match');
  const resultDiv = document.getElementById('result');
  const volumeSlider = document.getElementById('volume-slider'); // 볼륨 슬라이더
  const resultTable = document.getElementById('result-table'); // 결과 테이블
  const showTableButton = document.getElementById('show-table-button'); // 표 보이기/숨기기 버튼
  const attemptCountDisplay = document.getElementById('attempt-count'); // 시도 횟수 표시 요소
  const bestScoreDisplay = document.getElementById('best-score'); // 최고 점수 표시 요소

  // 시도 횟수 기록을 위한 변수
  let attemptCount = 0;

  // 최고 점수 변수
  let bestScore = 0;

  // 파형 종류
  const waveforms = ['sine', 'square', 'sawtooth', 'triangle'];

  // 정규 분포 난수 생성 함수 (로그 스케일 기준)
  function generateNormalRandomLogScale(mean, stdDev) {
    let u = 0, v = 0;
    while(u === 0) u = Math.random(); // 0을 피하기 위해
    while(v === 0) v = Math.random(); // 0을 피하기 위해
    let num = Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
    num = Math.exp(num * stdDev + mean); // 로그 스케일로 변환
    return num;
  }

  // 선형 스케일의 슬라이더 값을 로그 스케일로 변환하는 함수
  function linearToLogScale(linearValue, minLinear, maxLinear, minLog, maxLog) {
    const logRange = Math.log(maxLog) - Math.log(minLog);
    const linearRange = maxLinear - minLinear;
    const logScaleValue = Math.exp(Math.log(minLog) + logRange * (linearValue - minLinear) / linearRange);
    return logScaleValue;
  }

  // 로그 스케일의 슬라이더 값을 선형 스케일로 변환하는 함수
  function logToLinearScale(logValue, minLinear, maxLinear, minLog, maxLog) {
    const logRange = Math.log(maxLog) - Math.log(minLog);
    const linearRange = maxLinear - minLinear;
    const linearScaleValue = minLinear + linearRange * (Math.log(logValue) - Math.log(minLog)) / logRange;
    return linearScaleValue;
  }

  // 새 기준음 생성 함수 (기준음 + 조정음 파형 랜덤 설정)
    function generateNewReference() {
        // 기준음 파형 랜덤 선택
        referenceWaveform = waveforms[Math.floor(Math.random() * waveforms.length)];

        // 조정음 파형을 기준음과 다르게 선택
        const availableWaveforms = waveforms.filter(waveform => waveform !== referenceWaveform);
        adjustableWaveform = availableWaveforms[Math.floor(Math.random() * availableWaveforms.length)];

        // 로그 스케일 기준으로 정규 분포를 따르는 주파수 선택
        let desiredMeanFrequency = 880; // 원하는 평균 주파수를 선형 스케일로 설정 (예: 880Hz)
        let meanFrequencyLog = Math.log(desiredMeanFrequency); // 평균 주파수의 로그값
        let stdDevFrequencyLog = Math.log(3520 / 110) / 3; // 표준 편차 조정 (80%의 데이터가 더 좁은 범위에 분포하도록)
        referenceFrequency = generateNormalRandomLogScale(meanFrequencyLog, stdDevFrequencyLog);

        // 주파수 범위 제한
        if (referenceFrequency < 50) {
            referenceFrequency = 50;
        } else if (referenceFrequency > 4500) {
            referenceFrequency = 4500;
        }

        // 조정음 주파수 초기화 (440Hz)
        adjustableFrequency = 440;

        // 조정음 슬라이더 설정
        frequencySlider.value = logToLinearScale(adjustableFrequency, parseFloat(frequencySlider.min), parseFloat(frequencySlider.max), 50, 4500);
        frequencyInput.value = adjustableFrequency.toFixed(2);
    }

  // 기준음 재생/정지 함수
  function toggleReference() {
    if (isReferencePlaying) {
      stopReference();
    } else {
      playReference();
    }
  }

  // 조정음 재생/정지 함수
  function toggleAdjustable() {
    if (isAdjustablePlaying) {
      stopAdjustable();
    } else {
      playAdjustable();
    }
  }

  // 기준음 재생 함수
  function playReference() {
    if (referenceOscillator) {
      stopReference();
    }
    referenceOscillator = audioCtx.createOscillator();
    referenceOscillator.type = referenceWaveform;
    referenceOscillator.frequency.value = referenceFrequency;
    referenceOscillator.connect(gainNode);
    referenceOscillator.start();
    isReferencePlaying = true;
    referenceToggleButton.textContent = '■'; // 정지 버튼으로 변경
  }

  // 기준음 정지 함수
  function stopReference() {
    if (referenceOscillator) {
      referenceOscillator.stop();
      referenceOscillator = null;
    }
    isReferencePlaying = false;
    referenceToggleButton.textContent = '▶'; // 재생 버튼으로 변경
  }

  // 조정음 재생 함수 (파형 고정)
  function playAdjustable() {
    if (adjustableOscillator) {
      stopAdjustable();
    }
    adjustableOscillator = audioCtx.createOscillator();
    adjustableOscillator.type = adjustableWaveform;
    adjustableOscillator.frequency.value = adjustableFrequency;
    adjustableOscillator.connect(gainNode);
    adjustableOscillator.start();
    isAdjustablePlaying = true;
    adjustableToggleButton.textContent = '■'; // 정지 버튼으로 변경
  }

  // 조정음 정지 함수
  function stopAdjustable() {
    if (adjustableOscillator) {
      adjustableOscillator.stop();
      adjustableOscillator = null;
    }
    isAdjustablePlaying = false;
    adjustableToggleButton.textContent = '▶'; // 재생 버튼으로 변경
  }

  // 주파수 슬라이더/입력 이벤트 처리 (로그 스케일 적용)
  frequencySlider.addEventListener('input', () => {
    adjustableFrequency = linearToLogScale(parseFloat(frequencySlider.value), parseFloat(frequencySlider.min), parseFloat(frequencySlider.max), 50, 4500);
    frequencyInput.value = adjustableFrequency.toFixed(2);
    if (adjustableOscillator) {
      adjustableOscillator.frequency.value = adjustableFrequency;
    }
  });

  frequencyInput.addEventListener('input', () => {
    adjustableFrequency = parseFloat(frequencyInput.value);
    frequencySlider.value = logToLinearScale(adjustableFrequency, parseFloat(frequencySlider.min), parseFloat(frequencySlider.max), 50, 4500);
    if (adjustableOscillator) {
      adjustableOscillator.frequency.value = adjustableFrequency;
    }
  });

  // 볼륨 슬라이더 이벤트 처리
  volumeSlider.addEventListener('input', () => {
    gainNode.gain.value = parseFloat(volumeSlider.value);
  });

  // 일치 확인 버튼 이벤트 처리
  checkMatchButton.addEventListener('click', () => {
      const difference = Math.abs(referenceFrequency - adjustableFrequency);
      const differencePercentage = (difference / referenceFrequency) * 100;

      // 점수 계산 (오차가 적을수록 높은 점수)
      const score = Math.max(0, 100 - differencePercentage);

      // 최고 점수 업데이트
      if (score > bestScore) {
        bestScore = score;
        bestScoreDisplay.textContent = `최고 점수: ${bestScore.toFixed(2)}`;
      }

      // 시도 횟수 증가 및 기록
      attemptCount++;
      const newRow = resultTable.insertRow();
      const attemptCell = newRow.insertCell();
      const refWaveformCell = newRow.insertCell();
      const refFreqCell = newRow.insertCell();
      const adjWaveformCell = newRow.insertCell();
      const adjFreqCell = newRow.insertCell();
      const diffCell = newRow.insertCell();

      attemptCell.textContent = attemptCount;
      refWaveformCell.textContent = referenceWaveform;
      refFreqCell.textContent = referenceFrequency.toFixed(2);
      adjWaveformCell.textContent = adjustableWaveform;
      adjFreqCell.textContent = adjustableFrequency.toFixed(2);
      diffCell.textContent = `${difference.toFixed(2)} Hz (${differencePercentage.toFixed(2)}%)`;

      // 시도 횟수 표시 업데이트
      attemptCountDisplay.textContent = `시도 횟수: ${attemptCount}`;
  });

  // 버튼 이벤트 리스너
  newReferenceButton.addEventListener('click', generateNewReference);
  referenceToggleButton.addEventListener('click', toggleReference);
  adjustableToggleButton.addEventListener('click', toggleAdjustable);

  // 표 보이기/숨기기 버튼 이벤트 리스너
  showTableButton.addEventListener('click', () => {
    resultTable.hidden = !resultTable.hidden;
  });
  </script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyDWSQIrH2AV0_nnoU62bwxQPXTxGzj38ZQ",
      authDomain: "guessing-frequency.firebaseapp.com",
      projectId: "guessing-frequency",
      storageBucket: "guessing-frequency.firebasestorage.app",
      messagingSenderId: "484332200696",
      appId: "1:484332200696:web:dd67c347cdff1db5f1110d",
      measurementId: "G-YJ9PN730RH"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
  </script>
</body>
</html>
